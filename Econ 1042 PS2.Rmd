---
title: "Econ 1042 PS2"
author: "Owen Asnis"
date: "2023-02-13"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 3)
library(tidyverse)
library(readr)
library(lmtest)
```

# Data Wrangling 

```{r data wrangling, message=FALSE}

players <- read_delim("nhlps2.csv", delim = "\t", 
    escape_double = FALSE, trim_ws = TRUE)

standings <- read_csv("standings_2018_2019.csv", 
                      show_col_types = FALSE) %>% 
  select(-c(...11, ...12, ...13, ...14, ...15))

```

# Question 1 

### In baseball, expected home runs is a better representation than actual home runs because the expected statistics account for other variables. For example, one batter could be making hard contact but only have a few home runs because they play in Pittsburgh (ranked by Bleacher Report as the worst ballpark for hitters), whereas another batter could be making softer contact but have more home runs because they play in Colorado (considered to be the best ballpark for hitters). Even though the player from Pittsburgh has less home runs, we would still consider them to be a better hitter, as they would have more home runs than the player from Colorado if they played in the same conditions. In hockey, the total shots by each team while a player is on the ice might be a better indicator of a player's value than goals and assists because it similarly accounts for other variables. For example, one player could be generating many shots for and allowing few shots against but have scored no goals because their team was playing the best goalie in the league, whereas another player could be generating few shots for and allowing many shots against and scored a goal because their team was playing the worst goalie in the league. Again, the player generating many shots for and few shots against would be considered the better player because they would be more productive than the player generating few shots for and many shots against if they were playing in the same conditions. In basketball, thinking about shots doesn't work in the same way, because after one team scores, the other team gets the ball, leading to very similar shot totals. In hockey, if one team is dominating the other, there will be a large difference in shot totals. 

# Question 2 

### Corsi is the net difference in shots taken by your team and the other team, as defined by the problem set. Therefore, this variable is trying to measure how good a player is at generating shots for their team and limiting shots for the team they're playing. Like was said in the response to Question 1, Corsi is useful compared to just goals scored at both the team and the player level, because it accounts for other variables, like talent of the goalie, and shows how good a player is at producing offense and providing defense beyond just simple goal statistics.

# Question 3

### We care about a player's relative Corsi versus others on your team because a single player in hockey can only impact the game so much. There are 12 forwards and 6 defenders on a hockey team, and usually 5 players on the ice at any given time. Therefore, a player could have a negative Corsi when they are playing well if their team is struggling and another player could have a positive Corsi when they are struggling if their team is playing well. Relative Corsi accounts for the skill of the team a player is on and is therefore similar to the idea of a team fixed effect. For example, if you put Connor McDavid (the best hockey player in the NHL) on the Columbus Blue Jackets (the worst team in the NHL), his Corsi might be negative because although he's a great player, his team stinks. However, he would likely have a positive relative Corsi, because he would have a higher Corsi rating than many, if not all, of the players on his team. Here, relative Corsi is a better measure of the player's value. 

# Question 4 

```{r Q4}

pdo_model <- lm(lagged_pdo ~ pdo, 
                data = players)

pdo_bgtest <- bgtest(pdo_model, 
                     order = 8)
print(pdo_bgtest)

pdo_variable <- tibble(pdo = 103.38)

pdo_prediction <- round(predict(pdo_model, newdata = pdo_variable), 
                        digits = 2)

sprintf("PDO forecast in year t + 1: %s", 
        pdo_prediction)

total <- players %>% 
  nrow()

under <- players %>% 
  filter(pdo < pdo_prediction) %>% 
  nrow()

percentile <- round(((under/total) * 100), digits = 0)

sprintf("Corresponding percentile: %sst", percentile)

```

# Question 5 

```{r Q5}

goals_model <- lm(lagged_goals ~ goals,
                  data = players)

goals_bgtest <- bgtest(goals_model, 
                       order = 8)
print(goals_bgtest)

cfrel_model <- lm(lagged_cfrel_percent ~ cfrel_percent, 
                     data = players)

cfrel_bgtest <- bgtest(cfrel_model, 
                       order = 8)
print(cfrel_bgtest)

```
